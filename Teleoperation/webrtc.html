<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body, html {
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #2a2a2a;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    #main-container {
      display: flex;
      height: 100vh;
      flex-direction: row;
    }
    
    /* Video section takes most of the space */
    #video-section {
      flex: 1;
      position: relative;
      background: #000;
      min-width: 0; /* Important for flexbox */
    }
    
    /* Container for the video to allow an overlay */
    #video-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* The video fits within the container while maintaining aspect ratio */
    #video {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      display: block;
    }
    
    /* Overlay container for controls on top of the video, positioned at top-left */
    #video-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
    }
    #video-controls button {
      margin: 5px;
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.3);
      border: none;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
    }
    #video-controls button:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    #video-controls button.active {
      background: rgba(255, 255, 255, 0.6);
    }
    
    /* Chat section on the right side */
    #chat-section {
      width: 300px;
      background: #f5f5f5;
      border-left: 2px solid #ddd;
      display: flex;
      flex-direction: column;
      min-width: 0;
      transition: width 0.3s ease;
    }
    
    #chat-section.hidden {
      width: 0;
      border-left: none;
      overflow: hidden;
    }
    
    #chat-header {
      background: #e0e0e0;
      padding: 8px 12px;
      border-bottom: 1px solid #ccc;
      font-weight: bold;
      color: #333;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    #chat-toggle {
      background: #666;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    #chat-toggle:hover {
      background: #555;
    }
    
    /* Floating toggle button when chat is hidden */
    #floating-chat-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      z-index: 2000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    
    #floating-chat-toggle:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    
    #floating-chat-toggle.hidden {
      display: none;
    }
    
    #chat-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 10px;
      overflow: hidden;
    }
    
    #control-string {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-family: monospace;
      padding: 8px;
      font-size: 12px;
      color: #333;
      max-height: 60px;
      overflow-y: auto;
      word-wrap: break-word;
      word-break: break-all;
      white-space: pre-wrap;
    }
    
    #incoming-messages {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 8px;
      flex: 1;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      color: #333;
      word-wrap: break-word;
      word-break: break-word;
      white-space: pre-wrap;
    }
    
    #incoming-messages::-webkit-scrollbar {
      width: 8px;
    }
    
    #incoming-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    #incoming-messages::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    
    #incoming-messages::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>
<body>
  <div id="main-container">
    <!-- Video Section -->
    <div id="video-section">
      <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="video-controls">
          <button id="start-button">Click to Start and Enable Audio</button>
          <button id="mute-button" style="display:none;">Mute</button>
        </div>
      </div>
    </div>
    
    <!-- Chat Section -->
    <div id="chat-section">
      <div id="chat-header">
        <span>Control & Messages</span>
        <button id="chat-toggle">Hide</button>
      </div>
      <div id="chat-content">
        <div id="control-string"></div>
        <div id="incoming-messages"></div>
      </div>
    </div>
  </div>
  
  <!-- Floating toggle button for when chat is hidden -->
  <button id="floating-chat-toggle" class="hidden">Show Chat</button>
  
  <audio id="audio" autoplay playsinline muted style="display:none;"></audio>
  
  <script>
    // Global variable to hold the current WebSocket.
    let globalWS = null;
    let currentPC = null;

    function startSignaling() {
      // Create a new peer connection.
      currentPC = new RTCPeerConnection();

      const ws = new WebSocket("ws://64.225.55.176:8080");
      globalWS = ws;

      ws.onopen = () => {
        console.log("DEBUG: Browser connected to signaling server");
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        console.log("DEBUG: Browser received", data);
        if (data.type === "offer") {
          console.log("DEBUG: Received offer, setting remote description");
          await currentPC.setRemoteDescription({ type: "offer", sdp: data.sdp });
          const answer = await currentPC.createAnswer();
          await currentPC.setLocalDescription(answer);
          console.log("DEBUG: Sending answer");
          ws.send(JSON.stringify({
            type: "answer",
            sdp: answer.sdp
          }));
        } else if (data.type === "candidate") {
          try {
            console.log("DEBUG: Adding ICE candidate", data.candidate);
            await currentPC.addIceCandidate(data.candidate);
          } catch (err) {
            console.error("DEBUG: Error adding candidate", err);
          }
        } else if (data.type === "control") {
          const incomingDiv = document.getElementById("incoming-messages");
          const msgDiv = document.createElement("div");
          const content = data.controlString ? data.controlString : data.direction;
          msgDiv.textContent = "Received control: " + content;
          msgDiv.style.marginBottom = "4px";
          msgDiv.style.padding = "2px 0";
          msgDiv.style.borderBottom = "1px solid #eee";
          incomingDiv.appendChild(msgDiv);
          
          // Auto-scroll to bottom
          incomingDiv.scrollTop = incomingDiv.scrollHeight;
        }
      };

      ws.onclose = () => {
        console.log("DEBUG: WebSocket closed. Reconnecting in 5 seconds...");
        // Clean up the old peer connection.
        if (currentPC) {
          currentPC.close();
          currentPC = null;
        }
        setTimeout(startSignaling, 5000);
      };

      ws.onerror = (err) => {
        console.error("DEBUG: WebSocket error", err);
        ws.close();
      };

      currentPC.onicecandidate = (event) => {
        if (event.candidate) {
          const candidateMsg = JSON.stringify({
            type: "candidate",
            candidate: event.candidate
          });
          console.log("DEBUG: Sending ICE candidate", candidateMsg);
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(candidateMsg);
          }
        }
      };

      currentPC.ontrack = (event) => {
        event.streams.forEach((stream) => {
          if (stream.getVideoTracks().length > 0) {
            const video = document.getElementById("video");
            if (video.srcObject !== stream) {
              video.srcObject = stream;
              console.log("DEBUG: Attached video stream.");
            }
          }
          if (stream.getAudioTracks().length > 0) {
            const audioElement = document.getElementById("audio");
            if (audioElement.srcObject !== stream) {
              audioElement.srcObject = stream;
              console.log("DEBUG: Attached audio stream.");
            }
          }
        });
      };
    }

    // Start the signaling process immediately.
    startSignaling();

    // --- Control String and Audio Button Code ---
    const audioElement = document.getElementById("audio");
    const startButton = document.getElementById("start-button");
    startButton.addEventListener("click", () => {
      const video = document.getElementById("video");
      video.muted = false;
      audioElement.muted = false;
      video.play().then(() => {
        console.log("DEBUG: Video playback started with audio enabled.");
      }).catch((err) => {
        console.error("DEBUG: Error starting video playback:", err);
      });
      audioElement.play().then(() => {
        console.log("DEBUG: Audio playback initiated by user gesture.");
      }).catch(err => {
        console.error("DEBUG: Error initiating audio playback:", err);
      });
      startButton.style.display = "none";
      document.getElementById("mute-button").style.display = "inline-block";
    });
    
    const muteButton = document.getElementById("mute-button");
    muteButton.addEventListener("click", () => {
      const video = document.getElementById("video");
      if(video.muted) {
        video.muted = false;
        audioElement.muted = false;
        muteButton.textContent = "Mute";
      } else {
        video.muted = true;
        audioElement.muted = true;
        muteButton.textContent = "Unmute";
      }
    });

    // --- Control String Functionality ---
    const defaultFixedPart = "mac=asda;h1X=0;h1Y=0;h1Z=0;h1p=0;h1y=0;h1r=0;h2X=0;h2Y=0;h2Z=0;h2p=0;h2y=0;h2r=0;";
    let baseControlString = "";
    let controlState = { f: 0, b: 0, l: 0, r: 0, u: 0, d: 0 };

    function getControlString() {
      const base = baseControlString || defaultFixedPart;
      return base;
    }

    function updateControlDisplay() {
      document.getElementById("control-string").textContent = getControlString();
    }

    function sendControlString() {
      const controlStr = getControlString();
      // Send only if the current WebSocket exists and is open.
      if (globalWS && globalWS.readyState === WebSocket.OPEN) {
        globalWS.send(JSON.stringify({ type: "control", controlString: controlStr }));
        console.log("DEBUG: Sent control string:", controlStr);
      }
    }

    function setControl(key, value) {
      controlState[key] = value;
      updateControlDisplay();
      sendControlString();
    }

    updateControlDisplay();

    window.addEventListener("message", (event) => {
      if (event.data && event.data.controlString) {
        baseControlString = event.data.controlString;
        updateControlDisplay();
        console.log("DEBUG: Received updated control string via postMessage:", getControlString());
      }
    });

    // Send out the control string at 20 Hz (every 50 ms)
    setInterval(sendControlString, 50);
    
    // Chat toggle functionality
    function toggleChat() {
      const chatSection = document.getElementById('chat-section');
      const toggleButton = document.getElementById('chat-toggle');
      const floatingToggle = document.getElementById('floating-chat-toggle');
      
      chatSection.classList.toggle('hidden');
      
      if (chatSection.classList.contains('hidden')) {
        toggleButton.textContent = 'Show';
        floatingToggle.classList.remove('hidden');
      } else {
        toggleButton.textContent = 'Hide';
        floatingToggle.classList.add('hidden');
      }
    }
    
    // Add event listeners for both toggle buttons
    document.getElementById('chat-toggle').addEventListener('click', toggleChat);
    document.getElementById('floating-chat-toggle').addEventListener('click', toggleChat);
  </script>
</body>
</html>
